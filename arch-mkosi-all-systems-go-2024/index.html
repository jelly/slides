<!DOCTYPE html>
<html>
  <head>
    <title>Arch Linux images with mkosi</title>
    <meta charset="utf-8">
		<link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
  </head>
  <body>
    <textarea id="source">
count: false

<!--
 * Note use P and C for presentation mode and to duplicate the window and T to reset the timer
 * https://docs.jonasundderwolf.de/tech-guides/remarkjs/working-with-remarkjs/
*/
-->

# Arch Linux images with mkosi

### Can Arch Linux switch to mkosi for all our image artifacts?

#### Jelle van der Waa [&lt;jelle@archlinux.org&gt;](mailto:jelle@archlinux.org)

---

# $ whoami

* Arch Linux Developer

???

* Started packaging, end up with too many hats

---

# Arch Linux

* Rolling release distribution
* Adopted systemd early on
* Packaging uses sysusers/tmpfiles.d 

???

---

# mkosi

* Started by Lennart Poettering
* Currently maintained by Daan de Meyer & JÃ¶rg Behrmann
* Ini based configuration format
* Rootless building of images (namespaces)

---

# Alternatives

* osbuild
* kiwi
* both support Arch Linux

---

# Images

* VM image (40Gb)
* Cloud-init enabled image
* Vagrant images (libvirt or virtualbox backend)
* Archiso
* Container (hosted on dockerhub & quay)

???

---

# Current situation

* Self written Bash scripts
* Releases every two weeks
* Requires root privileges

???

---

# Porting to mkosi

* Profiles
   * vagrant
   * images

---

# Challenges

* btrfs swapfile support
* `install --owner=vagrant` is unsupported, use systemd tmpfiles

---

# Reproducible Builds

A build is reproducible if given the same source code, build environment and build instructions, any party can recreate bit-by-bit identical copies of all specified artifacts.

https://reproducible-builds.org

---

# Reproducibility issues

* Timestamps (SOURCE_DATE_EPOCH)
* Recorded hostname, version information, kernel used etc.
* Locale / recorded build paths
* Locale, sorting, build paths

???

---

# Reproducible Arch Linux Packages

* 90% Reproducible so far
* Installed packages scriptlets should be reproducible
* Reproducible minimal container image

https://reproducible.archlinux.org

https://lists.reproducible-builds.org/pipermail/rb-general/2024-March/003301.html

---


# Reproducible images

* Some prior work here done by [edgelesssys](https://github.com/edgelesssys/reproducible-mkosi)
* SourceDateEpoch option - clamp mtimes
* Seed option - reproducible partition UUID's

---

# Reproducible images

* Start analyzing images with diffoscope

---

# Reproducible images

```bash
diffoscope imageA.raw imageB.raw
```

---

# Reproducible images

```bash
diffoscope imageA.raw imageB.raw
```

```
[11111.1] Out of memory: Kill process 2603 (diffoscope) score 761 or sacrifice child
```

---

# Reproducible images

* Reduce the problem scope
* Output the image to a directory
* Diffoscope the directories

---

# Reproducible images

```bash
export SOURCE_DATE_EPOCH=1662046009
mkosi -d arch -p systemd --format directory \
      --source-date-epoch $SOURCE_DATE_EPOCH \
      -o foo \
      -m https://archive.archlinux.org/repos/2024/06/30/
mkosi -d arch -p systemd --format directory \
      --source-date-epoch $SOURCE_DATE_EPOCH \
      -o bar \
      -m https://archive.archlinux.org/repos/2024/06/30/
sudo diffoscope foo bar --html-dir output
xdg-open output/index.html
```

---

# Reproducible images

Two differences with a small image:

* var/cache/ldconfig/aux-cache (glibc)
* var/lib/pacman/local

```
20	%INSTALLDATE%   20	%INSTALLDATE%
21	1722251133      21	1722251028
```

---

# Reproducible images

lib/libalpm/add.c
```c
	/* make an install date (in UTC) */
	newpkg->installdate = time(NULL);
```

Workaround
```bash
sed -i -e '/INSTALLDATE/{n;s/.*/0/}' \
          "${BUILDROOT}"/var/lib/pacman/local/*/desc
```

Patch
https://gitlab.archlinux.org/pacman/pacman/-/merge_requests/213

---

# Reproducible cloud image

```bash
mkosi -d arch -p systemd -p linux -p base -p grub \
              -p openssh -p sudo -p reflector \
	      -p btrfs-progs -p udev \
	      --source-date-epoch 1662046009 \
	      --format directory -o bar \
	      -m https://archive.archlinux.org/repos/2024/06/30/
```

---

# Reproducible cloud image

* UKI unreproducible - diffoscope can't unpack EFI binaries
* Grub boot/EFI/Linux entry records timestamps
* Grub efi/loader/random-seed unreproducible (duh!)

???

* UKI => leftover /var/cache/ldconfig/aux-cache
* random-seed has been removed in mkosi (Thanks Daan)
* ukify-inspect is a useful tool

---

# Reproducible image filesystems

* Filesystems are created by systemd-repart
* Some mkfs programs support creating a filesystem with files

???

Creating a filesystem directly with the files included can be done without mounting so unprivileged and possibly easier to make reproducible

---

# Reproducible image filesystems

* vfat/ext4/f2fs/erofs can be made reproducible
* btrfs needs work
* xfs needs work

---

# Reproducible image filesystems

* vfat - can be made reproducible requires an upstream patch
* small fix in systemd-repart

https://github.com/systemd/systemd/pull/34180

---

# Thanks

* Daan

---

# Conclusion

---

# Questions

# 

    </textarea>
    <script src="js/remark-latest.min.js">
    </script>
    <script>
        const slideshow = remark.create({
            ratio: '16:9',
            countIncrementalSlides: false,
        });
    </script>
  </body>
</html>
